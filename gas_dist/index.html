<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ElecTest System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        secondary: '#475569',
                        accent: '#0d9488',
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', "Univalue", "Hiragino Kaku Gothic ProN", "Hiragino Sans", "Meiryo", "Yu Gothic", "Segoe UI", "Segoe UI Symbol", sans-serif;
        }

        /* 入力欄もフォントを統一 */
        input,
        textarea,
        button {
            font-family: inherit;
        }

        [v-cloak] {
            display: none !important;
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #2563eb;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #error-display {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #fef2f2;
            border-top: 2px solid #ef4444;
            color: #b91c1c;
            padding: 1rem;
            z-index: 9999;
            font-family: monospace;
            font-size: 0.9rem;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800 antialiased">
    <div id="error-display"></div>
    <script>
        window.onerror = function (msg, url, line) {
            var el = document.getElementById('error-display');
            el.style.display = 'block';
            el.innerHTML = '<strong>System Error:</strong> ' + msg + '<br><small>' + line + '</small>';
            return false;
        };
    </script>

    <div id="app" class="min-h-screen flex flex-col" v-cloak>
        <header class="bg-white shadow-sm z-10 sticky top-0">
            <div class="max-w-5xl mx-auto px-4 py-4 flex justify-between items-center">
                <h1 class="text-xl font-bold text-gray-800 tracking-tight flex items-center">
                    <i class="fa-solid fa-bolt text-yellow-500 mr-2"></i>
                    ElecTest System
                </h1>
                <div class="space-x-2">
                    <button @click="switchView('admin')"
                        :class="['px-3 py-1 rounded-full text-sm font-medium transition', currentView === 'admin' ? 'bg-primary text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200']">
                        管理者
                    </button>
                    <button @click="switchView('examinee')"
                        :class="['px-3 py-1 rounded-full text-sm font-medium transition', currentView === 'examinee' ? 'bg-accent text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200']">
                        受験者
                    </button>
                </div>
            </div>
        </header>

        <div v-if="isLoading" class="fixed inset-0 bg-white/80 z-50 flex items-center justify-center flex-col">
            <div class="loader mb-2" style="width: 40px; height: 40px; border-width: 4px;"></div>
            <p class="text-gray-600 font-medium">{{ loadingMessage }}</p>
        </div>

        <main class="flex-grow p-4 md:p-6">
            <div class="max-w-3xl mx-auto w-full">

                <div v-if="currentView === 'admin'" class="space-y-6">
                    <div
                        class="flex justify-between items-center bg-white p-4 rounded-lg shadow-sm border border-gray-100">
                        <div>
                            <h2 class="text-lg font-semibold text-gray-800">問題作成</h2>
                            <p class="text-sm text-gray-500">スプレッドシートに保存されます</p>
                        </div>
                        <button @click="finalizeQuestions"
                            class="bg-primary hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg shadow-md transition flex items-center gap-2">
                            <i class="fa-solid fa-save"></i> 問題を保存・確定
                        </button>
                    </div>

                    <div class="space-y-4">
                        <div v-for="(q, index) in questions" :key="q.id" draggable="true"
                            @dragstart="handleDragStart($event, index)" @dragover="handleDragOver"
                            @dragenter="handleDragEnter($event, index)" @drop="handleDrop(index)" :class="[
                                'bg-white rounded-xl shadow-sm border overflow-hidden transition-all duration-200',
                                dragIndex === index ? 'opacity-50 scale-95 border-primary border-dashed' : 'border-gray-200 hover:shadow-md',
                                dragTargetIndex === index && dragIndex !== index ? 'ring-2 ring-primary ring-offset-2' : ''
                            ]">
                            <div
                                class="bg-gray-50 px-4 py-2 border-b border-gray-100 flex justify-between items-center cursor-move">
                                <div class="flex items-center gap-3">
                                    <i class="fa-solid fa-grip-vertical text-gray-400"></i>
                                    <span class="font-bold text-gray-600">Q{{ index + 1 }}</span>
                                </div>
                                <div class="flex gap-2">
                                    <button @click="moveQuestion(index, -1)" :disabled="index === 0"
                                        class="text-gray-400 hover:text-primary w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-200 transition disabled:opacity-30">
                                        <i class="fa-solid fa-arrow-up"></i>
                                    </button>
                                    <button @click="moveQuestion(index, 1)" :disabled="index === questions.length - 1"
                                        class="text-gray-400 hover:text-primary w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-200 transition disabled:opacity-30">
                                        <i class="fa-solid fa-arrow-down"></i>
                                    </button>
                                    <div class="w-px bg-gray-300 mx-1 h-5 self-center"></div>
                                    <button @click="removeQuestion(index)"
                                        class="text-red-400 hover:text-red-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-50 transition">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="p-5 space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">問題文</label>
                                    <textarea v-model="q.text" rows="3" id="'q-text-' + index"
                                        class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary outline-none transition"></textarea>
                                    <!-- 記号入力ツールバー -->
                                    <div class="flex gap-2 mt-2 text-sm">
                                        <span class="text-gray-500 self-center">特殊記号:</span>
                                        <button v-for="char in ['Ω', 'μ', 'φ', 'θ', 'π', '∠']" :key="char"
                                            @click="insertChar(q, 'text', char)"
                                            class="bg-gray-100 hover:bg-gray-200 border border-gray-300 rounded px-2 py-1 min-w-[30px]">
                                            {{ char }}
                                        </button>
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">画像URL (任意)</label>
                                        <input type="text" v-model="q.imageUrl"
                                            class="w-full px-3 py-2 rounded-lg border border-gray-300 focus:ring-primary outline-none">
                                    </div>
                                    <div v-if="q.imageUrl"
                                        class="mt-2 p-2 bg-gray-50 rounded border border-gray-200 inline-block w-full">
                                        <p class="text-xs text-gray-500 mb-1">プレビュー:</p>
                                        <img :src="processImageUrl(q.imageUrl)" alt="Preview"
                                            class="h-32 object-contain rounded" referrerpolicy="no-referrer"
                                            @error="handleImageError">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">配点</label>
                                        <input type="number" v-model.number="q.points"
                                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-primary outline-none">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">採点基準・模範解答
                                        (AIへの指示)</label>
                                    <textarea v-model="q.criteria" rows="2"
                                        class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary outline-none transition"
                                        placeholder="例: 「オームの法則」という言葉があれば正解とする。計算式が合っていれば部分点を与える。"></textarea>
                                </div>
                            </div>
                            <div class="h-px bg-gray-200 my-4"></div>

                            <!-- Sub-Questions Section -->
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label class="block text-sm font-medium text-gray-700">小問設定 (オプション)</label>
                                    <button @click="addSubQuestion(q)"
                                        class="text-xs text-primary hover:underline flex items-center gap-1">
                                        <i class="fa-solid fa-plus-circle"></i> 小問を追加
                                    </button>
                                </div>

                                <div v-if="q.subQuestions && q.subQuestions.length > 0"
                                    class="space-y-4 bg-gray-50 p-4 rounded-lg border border-gray-200">
                                    <div v-for="(subQ, sIdx) in q.subQuestions" :key="subQ.id"
                                        class="bg-white p-3 rounded border border-gray-200 relative">
                                        <span
                                            class="absolute -left-3 -top-3 bg-secondary text-white w-6 h-6 flex items-center justify-center rounded-full text-xs font-bold border-2 border-white shadow-sm">
                                            {{ numberedCircle(sIdx + 1) }}
                                        </span>
                                        <button @click="removeSubQuestion(q, sIdx)"
                                            class="absolute top-2 right-2 text-gray-400 hover:text-red-500">
                                            <i class="fa-solid fa-times"></i>
                                        </button>

                                        <div class="grid gap-3">
                                            <div>
                                                <label class="text-xs font-bold text-gray-500">問題文</label>
                                                <textarea v-model="subQ.text" rows="2"
                                                    class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-primary outline-none"></textarea>
                                            </div>
                                            <div class="grid grid-cols-2 gap-3">
                                                <div>
                                                    <label class="text-xs font-bold text-gray-500">配点</label>
                                                    <input type="number" v-model.number="subQ.points"
                                                        class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-primary outline-none">
                                                </div>
                                                <div>
                                                    <label class="text-xs font-bold text-gray-500">採点基準</label>
                                                    <input type="text" v-model="subQ.criteria"
                                                        class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-primary outline-none"
                                                        placeholder="基準...">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <p v-else class="text-sm text-gray-400 italic">小問はありません。メインの配点と基準が適用されます。</p>
                            </div>
                        </div>
                    </div>
                </div>
                <button @click="addQuestion"
                    class="w-full py-4 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 hover:border-primary hover:text-primary hover:bg-blue-50 transition flex flex-col items-center justify-center gap-2">
                    <i class="fa-solid fa-circle-plus text-2xl"></i>問題を追加
                </button>
                <div class="h-10"></div>
            </div>

            <div v-else-if="currentView === 'examinee'" class="space-y-6">
                <div v-if="testResult" class="space-y-6">
                    <div class="bg-white rounded-xl shadow-lg border border-teal-100 p-8 text-center">
                        <i class="fa-solid fa-trophy text-5xl text-yellow-400 mb-4"></i>
                        <h2 class="text-2xl font-bold text-gray-800">試験終了</h2>
                        <p class="text-gray-500 mt-2">お疲れ様でした。採点結果は以下の通りです。</p>
                        <div class="mt-6 text-4xl font-black text-primary">
                            {{ testResult.totalScore }} <span class="text-lg text-gray-400 font-normal">点</span>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <h3 class="font-bold text-gray-700 text-lg">詳細フィードバック</h3>
                        <div v-for="(res, idx) in testResult.results" :key="idx"
                            class="bg-white rounded-lg p-5 border border-gray-200">
                            <div class="flex justify-between mb-2">
                                <span class="font-bold text-gray-600">Q{{ idx + 1 }}</span>
                                <span class="font-bold" :class="res.score > 0 ? 'text-primary' : 'text-red-500'">{{
                                    res.score }}点</span>
                            </div>

                            <div v-if="res.subQuestionId" class="mb-2 text-sm text-gray-500 font-bold">
                                小問 {{ getSubQNumber(res) }}
                            </div>
                            <p class="text-gray-700 bg-gray-50 p-3 rounded">{{ res.reason }}</p>
                        </div>
                    </div>
                    <button @click="resetTest"
                        class="w-full bg-gray-600 text-white py-3 rounded-lg hover:bg-gray-700 transition">終了して戻る</button>
                </div>

                <div v-else class="space-y-6">
                    <div v-if="questions.length === 0" class="text-center py-10 text-gray-500">
                        <p>現在、問題が登録されていません。</p>
                    </div>

                    <div v-else>
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-gray-500">問題 {{ currentQuestionIndex + 1 }} / {{
                                questions.length }}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 mb-6">
                            <div class="bg-accent h-2.5 rounded-full transition-all duration-300"
                                :style="{ width: ((currentQuestionIndex + 1) / questions.length) * 100 + '%' }">
                            </div>
                        </div>

                        <div v-if="currentQuestion"
                            class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
                            <div class="p-6 md:p-8 space-y-6">
                                <h3 class="text-xl font-bold text-gray-800 leading-relaxed">{{ currentQuestion.text
                                    }}</h3>

                                <div v-if="currentQuestion.imageUrl"
                                    class="flex justify-center bg-gray-50 p-4 rounded-lg">
                                    <img :src="processImageUrl(currentQuestion.imageUrl)"
                                        class="max-h-64 object-contain rounded shadow-sm" referrerpolicy="no-referrer"
                                        @error="handleImageError">
                                </div>

                                <div class="mt-6">
                                    <div v-if="currentQuestion.subQuestions && currentQuestion.subQuestions.length > 0"
                                        class="space-y-6">
                                        <div v-for="(sq, sIdx) in currentQuestion.subQuestions" :key="sq.id"
                                            class="space-y-2">
                                            <div class="flex items-start gap-2">
                                                <span class="font-bold text-lg text-primary">{{ numberedCircle(sIdx + 1)
                                                    }}</span>
                                                <p class="font-bold text-gray-800 pt-1">{{ sq.text }}</p>
                                            </div>
                                            <textarea v-model="getAnswerRef(currentQuestion.id, sq.id).value"
                                                class="w-full h-24 px-4 py-3 bg-gray-50 rounded-lg border border-gray-300 focus:bg-white focus:ring-2 focus:ring-accent outline-none transition resize-none"
                                                placeholder="回答を入力..."></textarea>
                                        </div>
                                    </div>
                                    <div v-else>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">回答欄</label>
                                        <textarea v-model="answers[currentQuestion.id]"
                                            class="w-full h-48 px-4 py-3 bg-gray-50 rounded-lg border border-gray-300 focus:bg-white focus:ring-2 focus:ring-accent outline-none transition resize-none"
                                            placeholder="ここに記述してください..."></textarea>
                                    </div>
                                </div>
                            </div>
                            <div
                                class="bg-gray-50 px-6 py-4 border-t border-gray-100 flex justify-between items-center">
                                <button @click="prevQuestion" :disabled="currentQuestionIndex === 0"
                                    class="px-5 py-2 rounded-lg text-gray-600 hover:bg-gray-200 disabled:text-gray-300">
                                    前へ
                                </button>

                                <button v-if="!isLastQuestion" @click="nextQuestion"
                                    class="bg-white border border-gray-300 hover:bg-gray-50 text-gray-800 px-6 py-2.5 rounded-lg shadow-sm font-medium transition">
                                    次へ
                                </button>

                                <button v-else @click="submitTest"
                                    class="bg-accent hover:bg-teal-700 text-white px-8 py-2.5 rounded-lg shadow-lg font-bold transition">
                                    採点する
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

    </div>
    </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.min.js"></script>
    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                const currentView = ref('admin');
                const isLoading = ref(false);
                const loadingMessage = ref('');
                const questions = ref([]);
                const currentQuestionIndex = ref(0);
                const answers = ref({});
                const testResult = ref(null);

                const isGasEnv = typeof google !== 'undefined' && google.script;

                const runGas = (funcName, ...args) => {
                    return new Promise((resolve, reject) => {
                        if (!isGasEnv) {
                            if (funcName === 'saveQuestions') return setTimeout(() => resolve({ success: true }), 500);
                            if (funcName === 'getQuestions') return setTimeout(() => resolve([
                                { id: '1', text: '(Local) Normal Question', points: 10 },
                                {
                                    id: '2', text: '(Local) Parent Question', points: 0, subQuestions: [
                                        { id: 'sq1', text: 'Sub Q1', points: 5, criteria: '' },
                                        { id: 'sq2', text: 'Sub Q2', points: 5, criteria: '' }
                                    ]
                                }
                            ]), 500);
                            if (funcName === 'submitAnswers') return setTimeout(() => resolve({
                                success: true,
                                totalScore: 15,
                                results: [
                                    { score: 10, reason: '(Local) Good', questionId: '1' },
                                    { score: 3, reason: '(Local) OK', questionId: '2', subQuestionId: 'sq1' },
                                    { score: 2, reason: '(Local) Weak', questionId: '2', subQuestionId: 'sq2' }
                                ]
                            }), 1500);
                            return resolve();
                        }
                        google.script.run
                            .withSuccessHandler(res => resolve(res))
                            .withFailureHandler(err => reject(err))
                        [funcName](...args);
                    });
                };

                const processImageUrl = (url) => {
                    if (!url) return '';
                    let match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
                    if (!match) match = url.match(/id=([a-zA-Z0-9_-]+)/);
                    if (match && match[1]) {
                        return 'https://drive.google.com/uc?export=view&id=' + match[1];
                    }
                    return url;
                };

                const handleImageError = (e) => {
                    console.error('Image load failed');
                };

                // 記号挿入ヘルパー - SubQuestion対応のために汎用化が必要だが、一旦簡易対応
                const insertChar = (obj, field, char) => {
                    if (!obj[field]) obj[field] = '';
                    obj[field] += char;
                };

                // 丸数字変換
                const numberedCircle = (num) => {
                    const chars = ['①', '②', '③', '④', '⑤', '⑥', '⑦', '⑧', '⑨', '⑩'];
                    return chars[num - 1] || `(${num})`;
                };

                const getSubQNumber = (res) => {
                    // 結果表示用ヘルパー
                    // 元の質問を探してインデックスを特定するのは高コストなので、APIが返すべきだが
                    // ここでは簡易的に実装できないため、IDマッチングを試みる
                    // ※本来はAPIレスポンスにindexを含めると楽
                    const q = questions.value.find(q => q.id === res.questionId);
                    if (!q || !q.subQuestions) return '?';
                    const idx = q.subQuestions.findIndex(sq => sq.id === res.subQuestionId);
                    return numberedCircle(idx + 1);
                };

                // 入れ子回答へのバインディング用
                const getAnswerRef = (qId, subId) => {
                    if (!answers.value[qId]) answers.value[qId] = {};
                    if (typeof answers.value[qId] !== 'object') answers.value[qId] = {}; // 既存データ保護

                    // refを返さないとv-modelが効かないため、computedプロパティ的なオブジェクトを返す
                    // Vue3のReactive Mapハック
                    return {
                        get value() { return answers.value[qId][subId] || ''; },
                        set value(v) { answers.value[qId][subId] = v; }
                    }
                };

                const loadQuestions = async () => {
                    isLoading.value = true;
                    loadingMessage.value = 'Loading questions...';
                    try {
                        const data = await runGas('getQuestions');
                        questions.value = data || [];
                        if (currentView.value === 'admin' && questions.value.length === 0) {
                            addQuestion();
                        }
                    } catch (e) {
                        alert('Error: ' + e);
                    } finally {
                        isLoading.value = false;
                    }
                };

                const switchView = async (view) => {
                    currentView.value = view;
                    testResult.value = null;
                    answers.value = {};
                    currentQuestionIndex.value = 0;
                    if (view === 'examinee' || view === 'admin') {
                        await loadQuestions();
                    }
                };

                const addQuestion = () => {
                    questions.value.push({ id: Date.now().toString(), text: '', imageUrl: '', points: 10, criteria: '' });
                };

                const removeQuestion = (index) => {
                    questions.value.splice(index, 1);
                };

                const addSubQuestion = (q) => {
                    if (!q.subQuestions) q.subQuestions = [];
                    q.subQuestions.push({
                        id: 'sq-' + Date.now() + Math.random().toString(36).substr(2, 5),
                        text: '',
                        points: 5,
                        criteria: ''
                    });
                };

                const removeSubQuestion = (q, index) => {
                    q.subQuestions.splice(index, 1);
                };

                const moveQuestion = (index, direction) => {
                    const newIndex = index + direction;
                    if (newIndex >= 0 && newIndex < questions.value.length) {
                        const item = questions.value.splice(index, 1)[0];
                        questions.value.splice(newIndex, 0, item);
                    }
                };

                const finalizeQuestions = async () => {
                    if (!confirm('Save questions?')) return;
                    isLoading.value = true;
                    loadingMessage.value = 'Saving...';
                    try {
                        const res = await runGas('saveQuestions', JSON.parse(JSON.stringify(questions.value)));
                        if (res.success) {
                            alert('Saved!');
                        } else {
                            alert('Save failed: ' + res.message);
                        }
                    } catch (e) {
                        alert('Error: ' + e);
                    } finally {
                        isLoading.value = false;
                    }
                };

                const currentQuestion = computed(() => questions.value[currentQuestionIndex.value]);
                const isLastQuestion = computed(() => currentQuestionIndex.value === questions.value.length - 1);

                const nextQuestion = () => { if (!isLastQuestion.value) currentQuestionIndex.value++; };
                const prevQuestion = () => { if (currentQuestionIndex.value > 0) currentQuestionIndex.value--; };

                const submitTest = async () => {
                    if (!confirm('Submit answers?')) return;
                    isLoading.value = true;
                    loadingMessage.value = 'Grading...';
                    try {
                        const res = await runGas('submitAnswers', JSON.parse(JSON.stringify(answers.value)));
                        if (res.success) {
                            testResult.value = res;
                        } else {
                            alert('Submit failed: ' + res.message);
                        }
                    } catch (e) {
                        alert('Error: ' + e);
                    } finally {
                        isLoading.value = false;
                    }
                };

                const resetTest = () => {
                    testResult.value = null;
                    answers.value = {};
                    currentQuestionIndex.value = 0;
                };

                onMounted(() => {
                    if (questions.value.length === 0) addQuestion();
                });

                const dragIndex = ref(null);
                const dragTargetIndex = ref(null);

                const handleDragStart = (e, index) => {
                    dragIndex.value = index;
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.dropEffect = 'move';
                    // ドラッグ中の要素を少し透明にするなどのスタイル適用はCSSクラスで行う
                };

                const handleDragEnter = (e, index) => {
                    if (index !== dragIndex.value) {
                        dragTargetIndex.value = index;
                    }
                };

                const handleDragOver = (e) => {
                    e.preventDefault(); // ドロップを許可するために必須
                    e.dataTransfer.dropEffect = 'move';
                };

                const handleDrop = (index) => {
                    const fromIndex = dragIndex.value;
                    const toIndex = index;

                    if (fromIndex === null || fromIndex === toIndex) {
                        dragIndex.value = null;
                        dragTargetIndex.value = null;
                        return;
                    }

                    // 配列の並び替え
                    const item = questions.value.splice(fromIndex, 1)[0];
                    questions.value.splice(toIndex, 0, item);

                    dragIndex.value = null;
                    dragTargetIndex.value = null;
                };

                return {
                    currentView, isLoading, loadingMessage, questions, currentQuestionIndex,
                    answers, testResult, currentQuestion, isLastQuestion,
                    switchView, addQuestion, removeQuestion, moveQuestion, finalizeQuestions,
                    nextQuestion, prevQuestion, submitTest, resetTest,
                    processImageUrl, handleImageError, insertChar,
                    handleDragStart, handleDragEnter, handleDragOver, handleDrop, dragIndex, dragTargetIndex,
                    addSubQuestion, removeSubQuestion, numberedCircle, getSubQNumber, getAnswerRef
                }
            }
        }).mount('#app');
    </script>
</body>

</html>