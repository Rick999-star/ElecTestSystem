<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ElecTest System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        secondary: '#475569',
                        accent: '#0d9488',
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', "Univalue", "Hiragino Kaku Gothic ProN", "Hiragino Sans", "Meiryo", "Yu Gothic", "Segoe UI", "Segoe UI Symbol", sans-serif;
        }

        /* 入力欄もフォントを統一 */
        input,
        textarea,
        button {
            font-family: inherit;
        }

        [v-cloak] {
            display: none !important;
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #2563eb;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #error-display {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #fef2f2;
            border-top: 2px solid #ef4444;
            color: #b91c1c;
            padding: 1rem;
            z-index: 9999;
            font-family: monospace;
            font-size: 0.9rem;
        }
    </style>
    <!-- KaTeX CSS and JS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
</head>

<body class="bg-gray-50 text-gray-800 antialiased">
    <div id="error-display"></div>
    <script>
        window.onerror = function (msg, url, line) {
            var el = document.getElementById('error-display');
            el.style.display = 'block';
            el.innerHTML = '<strong>System Error:</strong> ' + msg + '<br><small>' + line + '</small>';
            return false;
        };
    </script>

    <div id="app" class="min-h-screen flex flex-col" v-cloak>
        <header class="bg-white shadow-sm z-30 sticky top-0">
            <div class="max-w-5xl mx-auto px-4 py-4 flex justify-between items-center">
                <h1 class="text-xl font-bold text-gray-800 tracking-tight flex items-center">
                    <i class="fa-solid fa-bolt text-yellow-500 mr-2"></i>
                    ElecTest System <span class="ml-2 text-xs bg-gray-200 text-gray-600 px-2 py-0.5 rounded">v2.1</span>
                </h1>
                <div class="space-x-2 flex items-center" v-if="currentView !== 'landing'">
                    <!-- Connection Test Button (Admin Only) -->
                    <button v-if="currentView === 'admin'" @click="checkConnection"
                        class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1 rounded-full text-xs font-medium transition flex items-center gap-1 border border-gray-300"
                        title="API接続テスト">
                        <i class="fa-solid fa-network-wired"></i> 接続テスト
                    </button>
                    <button v-if="currentView === 'admin'" @click="checkGrading"
                        class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1 rounded-full text-xs font-medium transition flex items-center gap-1 border border-gray-300 ml-1"
                        title="採点ロジック単体テスト">
                        <i class="fa-solid fa-bug"></i> 採点テスト
                    </button>
                    <button v-if="currentView === 'admin'" @click="showDiagramManager = true"
                        class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1 rounded-full text-xs font-medium transition flex items-center gap-1 border border-gray-300 ml-1"
                        title="参考図・資料の管理">
                        <i class="fa-solid fa-images"></i> 参考図管理
                    </button>
                    <div class="w-px h-6 bg-gray-300 mx-1"></div>

                    <button @click="switchView('landing')"
                        class="px-3 py-1 rounded-full text-sm font-medium transition bg-gray-100 text-gray-600 hover:bg-gray-200">
                        <i class="fa-solid fa-home mr-1"></i>ホーム
                    </button>
                    <button @click="switchView('admin')"
                        :class="['px-3 py-1 rounded-full text-sm font-medium transition', currentView === 'admin' ? 'bg-primary text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200']">
                        管理者
                    </button>
                    <button @click="switchView('examinee')"
                        :class="['px-3 py-1 rounded-full text-sm font-medium transition', currentView === 'examinee' ? 'bg-accent text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200']">
                        受験者
                    </button>
                    <button v-if="currentView === 'examinee' && !testResult && questions.length > 0" @click="submitTest"
                        class="ml-2 bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-full text-sm font-medium transition flex items-center gap-1 shadow-sm">
                        <i class="fa-solid fa-flag-checkered"></i> 採点して終了
                    </button>
                </div>
            </div>
        </header>

        <div v-if="isLoading" class="fixed inset-0 bg-white/80 z-50 flex items-center justify-center flex-col">
            <div class="loader mb-2" style="width: 40px; height: 40px; border-width: 4px;"></div>
            <p class="text-gray-600 font-medium">{{ loadingMessage }}</p>
        </div>

        <main class="flex-grow p-4 md:p-6">
            <div class="max-w-3xl mx-auto w-full">

                <!-- Landing Page -->
                <div v-if="currentView === 'landing'"
                    class="flex flex-col items-center justify-center min-h-[60vh] space-y-12 animate-fade-in">
                    <div class="text-center space-y-4">
                        <div
                            class="inline-flex items-center justify-center w-24 h-24 rounded-full bg-blue-50 text-primary mb-2 shadow-inner">
                            <i class="fa-solid fa-bolt text-5xl"></i>
                        </div>
                        <h2 class="text-3xl font-bold text-gray-800 tracking-tight">ElecTest System</h2>
                        <p class="text-gray-500">試験システムへようこそ。ログインするロールを選択してください。</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full max-w-2xl px-4">
                        <button @click="switchView('admin')"
                            class="group relative flex flex-col items-center p-8 bg-white rounded-2xl shadow-sm hover:shadow-xl border-2 border-transparent hover:border-primary transition-all duration-300 transform hover:-translate-y-1">
                            <div
                                class="w-16 h-16 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mb-4 group-hover:scale-110 transition-transform shadow-sm">
                                <i class="fa-solid fa-user-shield text-2xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">管理者</h3>
                            <p class="text-sm text-gray-500 text-center leading-relaxed">
                                問題の作成・編集・管理を行います<br>(パスワードが必要です)</p>
                            <div
                                class="absolute inset-0 border-2 border-primary rounded-2xl opacity-0 group-hover:opacity-10 transition-opacity pointer-events-none">
                            </div>
                        </button>

                        <button @click="switchView('examinee')"
                            class="group relative flex flex-col items-center p-8 bg-white rounded-2xl shadow-sm hover:shadow-xl border-2 border-transparent hover:border-accent transition-all duration-300 transform hover:-translate-y-1">
                            <div
                                class="w-16 h-16 bg-teal-50 text-teal-600 rounded-full flex items-center justify-center mb-4 group-hover:scale-110 transition-transform shadow-sm">
                                <i class="fa-solid fa-pen-to-square text-2xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">受験者</h3>
                            <p class="text-sm text-gray-500 text-center leading-relaxed">試験を開始します<br>(どなたでもアクセス可能です)</p>
                            <div
                                class="absolute inset-0 border-2 border-accent rounded-2xl opacity-0 group-hover:opacity-10 transition-opacity pointer-events-none">
                            </div>
                        </button>
                    </div>
                </div>

                <div v-if="currentView === 'admin'" class="space-y-6">
                    <div
                        class="flex justify-between items-center bg-white p-4 rounded-lg shadow-sm border border-gray-100 mb-6">
                        <div class="flex-shrink-0 mr-4">
                            <h2 class="text-lg font-semibold text-gray-800">問題パターン管理</h2>
                            <p class="text-sm text-gray-500">作成した問題をパターンとして保存・呼び出しできます</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <button @click="createNewPattern"
                                class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1.5 rounded text-sm font-medium transition border border-gray-300 flex items-center gap-1">
                                <i class="fa-solid fa-file-circle-plus"></i> 新規作成
                            </button>
                            <div class="w-px h-10 bg-gray-200 mx-1"></div>
                            <div class="flex flex-col">
                                <label class="text-xs text-gray-500 mb-1">パターン保存</label>
                                <div class="flex gap-2">
                                    <input type="text" v-model="patternTitle" placeholder="パターン名 (例: 2024前期)"
                                        class="px-3 py-1.5 border border-gray-300 rounded text-sm w-48 focus:ring-1 focus:ring-primary outline-none">
                                    <button @click="savePattern" :disabled="!patternTitle"
                                        class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded text-sm font-medium transition disabled:bg-gray-300">
                                        <i class="fa-solid fa-save"></i> 保存
                                    </button>
                                </div>
                            </div>
                            <div class="w-px h-10 bg-gray-200 mx-2"></div>
                            <div class="flex flex-col flex-grow">
                                <label class="text-xs text-gray-500 mb-1">パターン読出</label>
                                <div class="flex gap-2">
                                    <select v-model="selectedPatternTitle"
                                        class="px-3 py-1.5 border border-gray-300 rounded text-sm w-full min-w-[300px] focus:ring-1 focus:ring-primary outline-none">
                                        <option value="" disabled>選択してください</option>
                                        <option v-for="p in savedPatterns" :key="p.title" :value="p.title">
                                            {{ p.title }} ({{ formatDate(p.updatedAt) }})
                                        </option>
                                    </select>
                                    <button @click="loadPattern" :disabled="!selectedPatternTitle"
                                        class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded text-sm font-medium transition disabled:bg-gray-300 whitespace-nowrap">
                                        <i class="fa-solid fa-folder-open"></i> 読込
                                    </button>
                                    <button @click="deletePattern" :disabled="!selectedPatternTitle"
                                        class="bg-gray-100 hover:bg-red-100 text-gray-500 hover:text-red-500 px-2 py-1.5 rounded text-sm font-medium transition disabled:text-gray-300"
                                        title="削除">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>


                    <!-- Deployed Status -->
                    <div v-if="currentDeployedPattern"
                        class="bg-teal-50 border border-teal-200 rounded-lg p-4 flex items-center justify-between animate-fade-in mx-4 mb-4">
                        <div class="flex items-center gap-3">
                            <div
                                class="w-10 h-10 rounded-full bg-teal-100 text-teal-600 flex items-center justify-center">
                                <i class="fa-solid fa-satellite-dish text-lg"></i>
                            </div>
                            <div>
                                <p class="text-xs text-teal-600 font-bold uppercase tracking-wide">Currently Deployed
                                </p>
                                <p class="text-gray-800 font-bold text-lg">{{ currentDeployedPattern }}</p>
                            </div>
                        </div>
                        <span
                            class="px-3 py-1 bg-white text-teal-600 border border-teal-200 rounded-full text-xs font-bold shadow-sm">
                            受験者画面に公開中
                        </span>
                    </div>


                    <div
                        class="flex justify-between items-center bg-white p-4 rounded-lg shadow-sm border border-gray-100 sticky top-[72px] z-20">
                        <div>
                            <h2 class="text-lg font-semibold text-gray-800">問題作成</h2>
                            <p class="text-sm text-gray-500">スプレッドシートに保存されます</p>
                        </div>
                        <button @click="finalizeQuestions"
                            class="bg-primary hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg shadow-md transition flex items-center gap-2">
                            <i class="fa-solid fa-save"></i> 問題を保存・確定
                        </button>
                    </div>

                    <div class="space-y-4">
                        <div v-for="(q, index) in questions" :key="q.id" draggable="true"
                            @dragstart="handleDragStart($event, index)" @dragover="handleDragOver"
                            @dragenter="handleDragEnter($event, index)" @drop="handleDrop(index)" :class="[
                                'bg-white rounded-xl shadow-sm border overflow-hidden transition-all duration-200',
                                dragIndex === index ? 'opacity-50 scale-95 border-primary border-dashed' : 'border-gray-200 hover:shadow-md',
                                dragTargetIndex === index && dragIndex !== index ? 'ring-2 ring-primary ring-offset-2' : ''
                            ]">
                            <div
                                class="bg-gray-50 px-4 py-2 border-b border-gray-100 flex justify-between items-center cursor-move">
                                <div class="flex items-center gap-3">
                                    <i class="fa-solid fa-grip-vertical text-gray-400"></i>
                                    <span class="font-bold text-gray-600">Q{{ index + 1 }}</span>
                                </div>
                                <div class="flex gap-2">
                                    <button @click="moveQuestion(index, -1)" :disabled="index === 0"
                                        class="text-gray-400 hover:text-primary w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-200 transition disabled:opacity-30">
                                        <i class="fa-solid fa-arrow-up"></i>
                                    </button>
                                    <button @click="moveQuestion(index, 1)" :disabled="index === questions.length - 1"
                                        class="text-gray-400 hover:text-primary w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-200 transition disabled:opacity-30">
                                        <i class="fa-solid fa-arrow-down"></i>
                                    </button>
                                    <div class="w-px bg-gray-300 mx-1 h-5 self-center"></div>
                                    <button @click="removeQuestion(index)"
                                        class="text-red-400 hover:text-red-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-50 transition">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="p-5 space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">問題文</label>
                                    <textarea v-model="q.text" rows="3" id="'q-text-' + index"
                                        class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary outline-none transition"
                                        placeholder="問題文を入力... ($$数式$$ でLaTeX記法が使えます)"></textarea>
                                    <div v-if="q.text" class="mt-2 p-3 bg-gray-50 rounded border border-gray-200">
                                        <p class="text-xs text-gray-500 font-bold mb-1">プレビュー:</p>
                                        <div v-html="renderMath(q.text)" class="text-gray-800 whitespace-pre-wrap">
                                        </div>
                                    </div>
                                    <!-- 記号入力ツールバー -->
                                    <div class="flex gap-2 mt-2 text-sm">
                                        <span class="text-gray-500 self-center">特殊記号:</span>
                                        <button v-for="char in ['Ω', 'μ', 'φ', 'θ', 'π', '∠']" :key="char"
                                            @click="insertChar(q, 'text', char)"
                                            class="bg-gray-100 hover:bg-gray-200 border border-gray-300 rounded px-2 py-1 min-w-[30px]">
                                            {{ char }}
                                        </button>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">参考図
                                        (配線図・シーケンス図など)</label>
                                    <select v-model="q.referenceDiagramId"
                                        class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-primary outline-none">
                                        <option value="">(なし: 問題単体で解く)</option>
                                        <option v-for="d in referenceDiagrams" :key="d.id" :value="d.id">{{ d.name }}
                                        </option>
                                    </select>
                                    <p class="text-xs text-gray-500 mt-1">※ 管理者用ツールバーの「参考図管理」から図を登録できます。</p>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">画像URL
                                            (任意)</label>
                                        <input type="text" v-model="q.imageUrl"
                                            class="w-full px-3 py-2 rounded-lg border border-gray-300 focus:ring-primary outline-none">
                                    </div>
                                    <div v-if="q.imageUrl"
                                        class="mt-2 p-2 bg-gray-50 rounded border border-gray-200 inline-block w-full">
                                        <p class="text-xs text-gray-500 mb-1">プレビュー:</p>
                                        <img :src="processImageUrl(q.imageUrl)" alt="Preview"
                                            class="h-32 object-contain rounded" referrerpolicy="no-referrer"
                                            @error="handleImageError">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">配点</label>
                                        <input type="number" v-model.number="q.points"
                                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-primary outline-none">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">採点基準
                                        (AIへの指示プロンプト)</label>
                                    <textarea v-model="q.criteria" rows="2"
                                        class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary outline-none transition"
                                        placeholder="例: 「オームの法則」という言葉があれば正解とする。計算式が合っていれば部分点を与える。"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">模範解答 (学生に表示)</label>
                                    <textarea v-model="q.modelAnswer" rows="2"
                                        class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-green-500 outline-none transition bg-green-50"
                                        placeholder="例: V = IR = 10 * 2 = 20[V]"></textarea>
                                </div>
                            </div>
                            <div class="h-px bg-gray-200 my-4"></div>

                            <!-- Sub-Questions Section -->
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label class="block text-sm font-medium text-gray-700">小問設定 (オプション)</label>
                                    <button @click="addSubQuestion(q)"
                                        class="text-xs text-primary hover:underline flex items-center gap-1">
                                        <i class="fa-solid fa-plus-circle"></i> 小問を追加
                                    </button>
                                </div>

                                <div v-if="q.subQuestions && q.subQuestions.length > 0"
                                    class="space-y-4 bg-gray-50 p-4 rounded-lg border border-gray-200">
                                    <div v-for="(subQ, sIdx) in q.subQuestions" :key="subQ.id"
                                        class="bg-white p-3 rounded border border-gray-200 relative">
                                        <span
                                            class="absolute -left-3 -top-3 bg-secondary text-white w-6 h-6 flex items-center justify-center rounded-full text-xs font-bold border-2 border-white shadow-sm">
                                            {{ numberedCircle(sIdx + 1) }}
                                        </span>
                                        <button @click="removeSubQuestion(q, sIdx)"
                                            class="absolute top-2 right-2 text-gray-400 hover:text-red-500">
                                            <i class="fa-solid fa-times"></i>
                                        </button>

                                        <div class="grid gap-3">
                                            <div>
                                                <label class="text-xs font-bold text-gray-500">問題文</label>
                                                <textarea v-model="subQ.text" rows="2"
                                                    class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-primary outline-none"></textarea>
                                                <div v-if="subQ.text"
                                                    class="mt-1 p-2 bg-gray-50 rounded border border-gray-200">
                                                    <div v-html="renderMath(subQ.text)"
                                                        class="text-xs text-gray-800 whitespace-pre-wrap"></div>
                                                </div>
                                            </div>
                                            <div class="grid grid-cols-2 gap-3">
                                                <div>
                                                    <label class="text-xs font-bold text-gray-500">配点</label>
                                                    <input type="number" v-model.number="subQ.points"
                                                        class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-primary outline-none">
                                                </div>
                                                <div>
                                                    <label class="text-xs font-bold text-gray-500">採点基準(AI)</label>
                                                    <input type="text" v-model="subQ.criteria"
                                                        class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-primary outline-none"
                                                        placeholder="プロンプト...">
                                                </div>
                                                <div class="col-span-2">
                                                    <label class="text-xs font-bold text-gray-500">模範解答(表示用)</label>
                                                    <input type="text" v-model="subQ.modelAnswer"
                                                        class="w-full px-2 py-1 text-sm border border-green-300 rounded focus:ring-1 focus:ring-green-500 outline-none bg-green-50"
                                                        placeholder="正解...">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <p v-else class="text-sm text-gray-400 italic">小問はありません。メインの配点と基準が適用されます。</p>
                            </div>
                        </div>
                    </div>
                    <button @click="addQuestion"
                        class="w-full py-4 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 hover:border-primary hover:text-primary hover:bg-blue-50 transition flex flex-col items-center justify-center gap-2">
                        <i class="fa-solid fa-circle-plus text-2xl"></i>問題を追加
                    </button>
                    <div class="h-10"></div>
                </div>

                <div v-if="currentView === 'examinee'" class="space-y-6">
                    <div v-if="testResult" class="space-y-6">
                        <div class="bg-white rounded-xl shadow-lg border border-teal-100 p-8 text-center">
                            <i class="fa-solid fa-trophy text-5xl text-yellow-400 mb-4"></i>
                            <h2 class="text-2xl font-bold text-gray-800">試験終了</h2>
                            <p class="text-gray-500 mt-2">お疲れ様でした。採点結果は以下の通りです。</p>
                            <div class="mt-6 text-4xl font-black text-primary">
                                {{ testResult.totalScore }} <span class="text-xl text-gray-400 font-normal">/ {{
                                    totalMaxScore }} 点</span>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <h3 class="font-bold text-gray-700 text-lg">詳細フィードバック</h3>
                            <div v-for="(res, idx) in testResult.results" :key="idx"
                                class="bg-white rounded-lg p-5 border border-gray-200 shadow-sm">

                                <div class="flex justify-between items-start mb-4">
                                    <div class="flex items-center gap-3">
                                        <span class="font-bold text-gray-500">Q{{ getQuestionNumber(res) }}</span>
                                        <span
                                            :class="['px-2 py-1 rounded text-xs font-bold border flex items-center gap-1', getResultStatus(res).class]">
                                            <i :class="['fa-solid', getResultStatus(res).icon]"></i>
                                            {{ getResultStatus(res).label }}
                                        </span>
                                        <span v-if="res.subQuestionId"
                                            class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-600">
                                            小問 {{ getSubQNumber(res) }}
                                        </span>
                                    </div>
                                    <div class="text-xl font-bold"
                                        :class="res.score > 0 ? 'text-primary' : 'text-gray-400'">
                                        {{ res.score }} <span class="text-sm font-normal text-gray-500">点</span>
                                    </div>
                                </div>

                                <div class="mb-4" v-if="getQuestionImage(res)">
                                    <p class="text-xs text-gray-400 font-bold mb-1">参考画像</p>
                                    <img :src="processImageUrl(getQuestionImage(res))"
                                        class="h-32 object-contain rounded border border-gray-100 bg-gray-50"
                                        referrerpolicy="no-referrer" @error="handleImageError">
                                </div>

                                <div class="mb-4">
                                    <p class="text-xs text-gray-400 font-bold mb-1">問題文</p>
                                    <div class="text-gray-800 font-medium whitespace-pre-wrap"
                                        v-html="renderMath(getQuestionText(res))"></div>
                                </div>

                                <div class="mb-4">
                                    <p class="text-xs text-gray-400 font-bold mb-1">あなたの回答</p>
                                    <p
                                        class="text-gray-700 p-3 bg-gray-50 rounded border border-gray-100 whitespace-pre-wrap">
                                        {{ getUserAnswer(res) }}</p>
                                </div>

                                <div>
                                    <p class="text-xs text-gray-400 font-bold mb-1">AI講評</p>
                                    <div class="flex gap-3">
                                        <i class="fa-solid fa-robot text-primary mt-1"></i>
                                        <p class="text-gray-600 text-sm leading-relaxed"
                                            style="font-family: 'Segoe UI Symbol', 'Noto Sans JP', sans-serif;">{{
                                            res.reason }}</p>
                                    </div>
                                </div>

                                <div v-if="getResultStatus(res).label !== '正解'"
                                    class="mt-4 pt-4 border-t border-gray-100">
                                    <p class="text-xs text-red-500 font-bold mb-1">模範解答</p>
                                    <div class="text-gray-700 bg-red-50 p-3 rounded border border-red-100 whitespace-pre-wrap text-sm"
                                        style="font-family: 'Segoe UI Symbol', 'Noto Sans JP', sans-serif;"
                                        v-html="renderMath(getModelAnswer(res))"></div>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-4">
                            <button @click="downloadResultsCSV"
                                class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg transition border border-green-700 shadow-sm flex items-center justify-center gap-2">
                                <i class="fa-solid fa-file-csv"></i> 結果を保存(CSV)
                            </button>
                            <button @click="resetTest"
                                class="flex-1 bg-gray-600 text-white py-3 rounded-lg hover:bg-gray-700 transition">終了して戻る</button>
                        </div>
                    </div>

                    <div v-else class="space-y-6">
                        <div v-if="questions.length === 0" class="text-center py-10 text-gray-500">
                            <p>現在、問題が登録されていません。</p>
                        </div>

                        <div v-else>
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium text-gray-500">問題 {{ currentQuestionIndex + 1 }} /
                                    {{
                                    questions.length }}</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5 mb-6">
                                <div class="bg-accent h-2.5 rounded-full transition-all duration-300"
                                    :style="{ width: ((currentQuestionIndex + 1) / questions.length) * 100 + '%' }">
                                </div>
                            </div>

                            <div v-if="currentQuestion"
                                class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
                                <div class="p-6 md:p-8 space-y-6">
                                    <div v-if="currentQuestion.referenceDiagramId" class="mb-2">
                                        <button @click="viewDiagram(currentQuestion.referenceDiagramId)"
                                            class="w-full bg-blue-50 hover:bg-blue-100 text-blue-700 font-bold py-3 px-4 rounded-lg border border-blue-200 shadow-sm transition flex items-center justify-center gap-2">
                                            <i class="fa-solid fa-book-open"></i> 参考図を表示する
                                        </button>
                                    </div>

                                    <!-- Pre-grading CSV Export Button (Visible on all questions for convenience, or adjust as needed) -->
                                    <div class="flex justify-end mb-2">
                                        <button @click="downloadAnswersCSV"
                                            class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1.5 rounded border border-gray-300 transition flex items-center gap-1">
                                            <i class="fa-solid fa-file-csv"></i> 解答を一時保存(CSV)
                                        </button>
                                    </div>

                                    <div class="text-xl font-bold text-gray-800 leading-relaxed whitespace-pre-wrap"
                                        v-html="renderMath(currentQuestion.text)"></div>

                                    <div v-if="currentQuestion.imageUrl"
                                        class="flex justify-center bg-gray-50 p-4 rounded-lg">
                                        <img :src="processImageUrl(currentQuestion.imageUrl)"
                                            class="max-h-64 object-contain rounded shadow-sm"
                                            referrerpolicy="no-referrer" @error="handleImageError">
                                    </div>

                                    <div class="mt-6">
                                        <div v-if="currentQuestion.subQuestions && currentQuestion.subQuestions.length > 0"
                                            class="space-y-6">
                                            <div v-for="(sq, sIdx) in currentQuestion.subQuestions" :key="sq.id"
                                                class="space-y-2">
                                                <div class="flex items-start gap-2">
                                                    <span class="font-bold text-lg text-primary">{{
                                                        numberedCircle(sIdx
                                                        + 1)
                                                        }}</span>
                                                    <div class="font-bold text-gray-800 pt-1 whitespace-pre-wrap"
                                                        v-html="renderMath(sq.text)"></div>
                                                </div>
                                                <textarea v-model="getAnswerRef(currentQuestion.id, sq.id).value"
                                                    class="w-full h-24 px-4 py-3 bg-gray-50 rounded-lg border border-gray-300 focus:bg-white focus:ring-2 focus:ring-accent outline-none transition resize-none"
                                                    placeholder="回答を入力..."></textarea>
                                            </div>
                                        </div>
                                        <div v-else>
                                            <label class="block text-sm font-semibold text-gray-700 mb-2">回答欄</label>
                                            <textarea v-model="answers[currentQuestion.id]"
                                                class="w-full h-48 px-4 py-3 bg-gray-50 rounded-lg border border-gray-300 focus:bg-white focus:ring-2 focus:ring-accent outline-none transition resize-none"
                                                placeholder="ここに記述してください..."></textarea>
                                        </div>
                                    </div>
                                </div>
                                <div
                                    class="bg-gray-50 px-6 py-4 border-t border-gray-100 flex justify-between items-center">
                                    <button @click="prevQuestion" :disabled="currentQuestionIndex === 0"
                                        class="px-5 py-2 rounded-lg text-gray-600 hover:bg-gray-200 disabled:text-gray-300">
                                        前へ
                                    </button>

                                    <div class="flex items-center gap-3">
                                        <button v-if="!isLastQuestion" @click="nextQuestion"
                                            class="bg-white border border-gray-300 hover:bg-gray-50 text-gray-800 px-6 py-2.5 rounded-lg shadow-sm font-medium transition">
                                            次へ
                                        </button>

                                        <button v-else @click="submitTest"
                                            class="bg-accent hover:bg-teal-700 text-white px-8 py-2.5 rounded-lg shadow-lg font-bold transition">
                                            採点する
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
        </main>
        <!-- Password Modal -->
        <div v-if="showPasswordModal"
            class="fixed inset-0 bg-black/60 z-[100] flex items-center justify-center backdrop-blur-sm p-4 animate-fade-in"
            v-cloak>
            <div
                class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all scale-100">
                <div
                    class="bg-primary px-6 py-4 flex justify-between items-center bg-gradient-to-r from-blue-600 to-blue-500">
                    <h3 class="text-lg font-bold text-white flex items-center gap-2"><i class="fa-solid fa-lock"></i>
                        管理者認証
                    </h3>
                    <button @click="showPasswordModal = false; inputPassword = ''; authError = '';"
                        class="text-white/80 hover:text-white transition">
                        <i class="fa-solid fa-times text-lg"></i>
                    </button>
                </div>
                <div class="p-8 space-y-6">
                    <p class="text-gray-600 text-sm">管理画面に進むにはパスワードを入力してください。</p>
                    <div class="space-y-2">
                        <input type="password" v-model="inputPassword" @keyup.enter="checkPassword"
                            placeholder="パスワードを入力" autofocus
                            class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 focus:border-primary focus:ring-4 focus:ring-blue-50 outline-none transition text-lg tracking-widest placeholder-gray-400">
                        <p v-if="authError"
                            class="text-red-500 text-xs font-bold flex items-center gap-1 animate-pulse">
                            <i class="fa-solid fa-circle-exclamation"></i>{{ authError }}
                        </p>
                    </div>
                    <div class="flex justify-end gap-3 pt-2">
                        <button @click="showPasswordModal = false; inputPassword = ''; authError = '';"
                            class="px-5 py-2.5 text-gray-500 hover:bg-gray-100 rounded-lg transition font-medium text-sm">キャンセル</button>
                        <button @click="checkPassword"
                            class="px-6 py-2.5 bg-primary hover:bg-blue-600 text-white font-bold rounded-lg shadow-md hover:shadow-lg transition text-sm flex items-center gap-2">
                            <i class="fa-solid fa-arrow-right-to-bracket"></i> ログイン
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Name Input Modal -->
        <div v-if="showNameModal"
            class="fixed inset-0 bg-black/60 z-[100] flex items-center justify-center backdrop-blur-sm p-4 animate-fade-in"
            v-cloak>
            <div
                class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all scale-100">
                <div
                    class="bg-accent px-6 py-4 flex justify-between items-center bg-gradient-to-r from-teal-600 to-teal-500">
                    <h3 class="text-lg font-bold text-white flex items-center gap-2"><i
                            class="fa-solid fa-user-pen"></i>
                        受験者情報入力
                    </h3>
                    <!-- Close button disabled to force input -->
                </div>
                <div class="p-8 space-y-6">
                    <div class="bg-teal-50 p-4 rounded-lg border border-teal-100 mb-4" v-if="currentDeployedPattern">
                        <p class="text-xs text-teal-600 font-bold uppercase tracking-wide mb-1">試験パターン</p>
                        <p class="text-gray-800 font-bold text-lg">{{ currentDeployedPattern }}</p>
                    </div>

                    <p class="text-gray-600 text-sm">試験を開始する前に、あなたのお名前を入力してください。</p>
                    <div class="space-y-2">
                        <label class="block text-sm font-bold text-gray-700">お名前</label>
                        <input type="text" v-model="studentName" @keyup.enter="startExam" placeholder="例: 山田 太郎"
                            autofocus
                            class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 focus:border-accent focus:ring-4 focus:ring-teal-50 outline-none transition text-lg placeholder-gray-400">
                        <p v-if="nameError"
                            class="text-red-500 text-xs font-bold flex items-center gap-1 animate-pulse">
                            <i class="fa-solid fa-circle-exclamation"></i>{{ nameError }}
                        </p>
                    </div>
                    <div class="flex justify-end gap-3 pt-4">
                        <button @click="cancelExam"
                            class="px-5 py-2.5 text-gray-500 hover:bg-gray-100 rounded-lg transition font-medium text-sm">キャンセル</button>
                        <button @click="startExam" :disabled="isLoading"
                            class="px-6 py-2.5 bg-accent hover:bg-teal-700 text-white font-bold rounded-lg shadow-md hover:shadow-lg transition text-sm flex items-center gap-2 disabled:opacity-50">
                            <i class="fa-solid fa-play"></i> 試験開始
                            <i v-if="isLoading" class="fa-solid fa-circle-notch fa-spin"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Diagram Manager Modal (Admin) -->
        <div v-if="showDiagramManager"
            class="fixed inset-0 bg-black/60 z-[100] flex items-center justify-center backdrop-blur-sm p-4 animate-fade-in"
            v-cloak>
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[90vh]">
                <div class="bg-gray-800 px-6 py-4 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-white flex items-center gap-2">
                        <i class="fa-solid fa-images"></i> 参考図・資料管理
                    </h3>
                    <button @click="showDiagramManager = false" class="text-white/70 hover:text-white">
                        <i class="fa-solid fa-times text-lg"></i>
                    </button>
                </div>
                <div class="p-6 overflow-y-auto flex-grow space-y-4">
                    <p class="text-sm text-gray-600 bg-gray-100 p-3 rounded">
                        ここで登録した図は、問題作成時に紐付けることができます。<br>
                        Google Driveの画像を貼り付ける場合は、共有リンクを使用してください。
                    </p>

                    <div v-for="(d, idx) in referenceDiagrams" :key="d.id"
                        class="flex gap-2 items-start bg-gray-50 p-3 rounded border border-gray-200">
                        <div class="flex-grow space-y-2">
                            <input type="text" v-model="d.name" placeholder="図の名称 (例: 配線図①)"
                                class="w-full px-3 py-1.5 text-sm border rounded focus:ring-1 focus:ring-primary outline-none">
                            <input type="text" v-model="d.url" placeholder="画像URL"
                                class="w-full px-3 py-1.5 text-sm border rounded focus:ring-1 focus:ring-primary outline-none text-gray-600 font-mono">
                            <div v-if="d.url" class="mt-1">
                                <span class="text-xs text-gray-400">プレビュー:</span>
                                <img :src="processImageUrl(d.url)" class="h-16 object-contain border bg-white mt-1"
                                    referrerpolicy="no-referrer">
                            </div>
                        </div>
                        <button @click="removeDiagram(idx)" class="text-gray-400 hover:text-red-500 p-2">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>

                    <button @click="addDiagram"
                        class="w-full py-2 border-2 border-dashed border-gray-300 rounded text-gray-500 hover:text-primary hover:border-primary hover:bg-blue-50 transition text-sm font-bold flex items-center justify-center gap-2">
                        <i class="fa-solid fa-plus"></i> 新しい図を追加
                    </button>
                </div>
                <div class="p-4 border-t bg-gray-50 flex justify-end gap-3">
                    <button @click="showDiagramManager = false"
                        class="px-4 py-2 text-gray-600 hover:bg-gray-200 rounded transition text-sm">キャンセル</button>
                    <button @click="saveDiagramsList"
                        class="px-6 py-2 bg-primary hover:bg-blue-700 text-white rounded font-bold shadow transition text-sm">
                        <i class="fa-solid fa-save"></i> 保存する
                    </button>
                </div>
            </div>
        </div>

        <!-- Diagram Viewer Modal (Examinee/General) -->
        <div v-if="showDiagramViewer" class="fixed inset-0 bg-black/90 z-[200] flex flex-col animate-fade-in" v-cloak>
            <div class="flex justify-end p-4">
                <button @click="showDiagramViewer = false"
                    class="text-white/70 hover:text-white bg-white/10 hover:bg-white/20 rounded-full w-10 h-10 flex items-center justify-center transition">
                    <i class="fa-solid fa-times text-xl"></i>
                </button>
            </div>
            <div class="flex-grow flex items-center justify-center p-4 overflow-hidden">
                <img :src="currentDiagramUrl" class="max-w-full max-h-full object-contain rounded shadow-2xl"
                    referrerpolicy="no-referrer">
            </div>
        </div>

        <!-- Floating Action Button for Diagram List (Visible on Grading Result Screen) -->
        <button v-if="testResult && referenceDiagrams.length > 0" @click="showDiagramList = true"
            class="fixed bottom-6 right-6 bg-blue-600 hover:bg-blue-700 text-white rounded-full p-4 shadow-xl z-50 transition transform hover:scale-105 flex items-center justify-center w-16 h-16"
            title="参考図一覧を表示">
            <i class="fa-solid fa-images text-2xl"></i>
        </button>

        <!-- Diagram List Modal -->
        <div v-if="showDiagramList"
            class="fixed inset-0 bg-black/60 z-[120] flex items-center justify-center backdrop-blur-sm p-4 animate-fade-in"
            v-cloak>
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[80vh]">
                <div class="bg-blue-600 px-6 py-4 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-white flex items-center gap-2">
                        <i class="fa-solid fa-images"></i> 参考図一覧
                    </h3>
                    <button @click="showDiagramList = false" class="text-white/70 hover:text-white">
                        <i class="fa-solid fa-times text-lg"></i>
                    </button>
                </div>
                <div class="p-6 overflow-y-auto flex-grow space-y-3">
                    <p class="text-gray-600 text-sm mb-4">閲覧したい図を選択してください。</p>
                    <button v-for="d in referenceDiagrams" :key="d.id"
                        @click="viewDiagram(d.id); showDiagramList = false"
                        class="w-full text-left bg-gray-50 hover:bg-blue-50 border border-gray-200 hover:border-blue-300 rounded-lg p-4 transition flex items-center justify-between group">
                        <span class="font-bold text-gray-700 group-hover:text-blue-700">{{ d.name }}</span>
                        <i class="fa-solid fa-chevron-right text-gray-400 group-hover:text-blue-500"></i>
                    </button>
                </div>
                <div class="p-4 border-t bg-gray-50 flex justify-end">
                    <button @click="showDiagramList = false"
                        class="px-5 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium transition text-sm">閉じる</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.min.js" crossorigin></script>
    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;

        if (typeof createApp !== 'function') {
            throw new Error('Vue.js check failed: createApp is not a function.');
        }

        try {
            const app = createApp({
                setup() {
                    const currentView = ref('landing');
                    const isAuthenticated = ref(false);
                    const showPasswordModal = ref(false);
                    const inputPassword = ref('');
                    const authError = ref('');
                    const isLoading = ref(false);
                    const loadingMessage = ref('');
                    const questions = ref([]);
                    const currentQuestionIndex = ref(0);
                    const answers = ref({});
                    const testResult = ref(null);
                    const patternTitle = ref('');
                    const selectedPatternTitle = ref('');
                    const savedPatterns = ref([]);
                    const currentDeployedPattern = ref('');
                    const showNameModal = ref(false);
                    const studentName = ref('');
                    const sessionId = ref(null);
                    const nameError = ref('');

                    // Reference Diagrams State
                    const referenceDiagrams = ref([]);
                    const showDiagramManager = ref(false); // Admin Modal
                    const showDiagramViewer = ref(false);  // Examinee Modal
                    const showDiagramList = ref(false);    // Examinee List Modal
                    const currentDiagramUrl = ref(''); // For Viewer

                    // Retry State
                    const isGradingFailed = ref(false);

                    const isGasEnv = typeof google !== 'undefined' && google.script;

                    // ... (runGas helper omitted - no change) ...
                    const runGas = (funcName, ...args) => {
                        return new Promise((resolve, reject) => {
                            const timeoutId = setTimeout(() => {
                                reject(new Error('Timeout: サーバーからの応答がありません。300秒以上経過しました。'));
                            }, 300000);

                            if (!isGasEnv) {
                                clearTimeout(timeoutId);
                                if (funcName === 'saveTemporaryAnswers') return setTimeout(() => resolve({ success: true }), 300);
                                if (funcName === 'saveQuestions') return setTimeout(() => resolve({ success: true }), 500);
                                if (funcName === 'getDeployedPatternTitle') return setTimeout(() => resolve('Mock Deployed Pattern (Local)'), 500);
                                if (funcName === 'savePattern') return setTimeout(() => resolve({ success: true, message: 'Mock Saved' }), 500);
                                if (funcName === 'getPatternList') return setTimeout(() => resolve([
                                    { title: 'Mock Pattern A', updatedAt: new Date() },
                                    { title: 'Mock Pattern B', updatedAt: new Date(Date.now() - 86400000) }
                                ]), 500);
                                if (funcName === 'getPattern') return setTimeout(() => resolve({
                                    success: true,
                                    questions: [
                                        { id: 'p1', text: '(Pattern) Loaded Question', points: 10 }
                                    ]
                                }), 500);
                                if (funcName === 'deletePattern') return setTimeout(() => resolve({ success: true }), 500);
                                if (funcName === 'testGeminiConnection') return setTimeout(() => resolve({ success: true, message: '(Mock) Connection OK' }), 500);
                                if (funcName === 'testGrading') return setTimeout(() => resolve({ success: true, message: '(Mock) Grading OK', details: [] }), 1000);
                                if (funcName === 'getQuestions') return setTimeout(() => resolve([
                                    { id: '1', text: '(Local) Normal Question', points: 10 },
                                    {
                                        id: '2', text: '(Local) Parent Question', points: 0, subQuestions: [
                                            { id: 'sq1', text: 'Sub Q1', points: 5, criteria: '' },
                                            { id: 'sq2', text: 'Sub Q2', points: 5, criteria: '' }
                                        ]
                                    }
                                ]), 500);
                                if (funcName === 'submitAnswers') return setTimeout(() => resolve({
                                    success: true,
                                    totalScore: 15,
                                    results: [
                                        { score: 10, reason: '(Local) Good', questionId: '1' },
                                        { score: 3, reason: '(Local) OK', questionId: '2', subQuestionId: 'sq1' },
                                        { score: 2, reason: '(Local) Weak', questionId: '2', subQuestionId: 'sq2' }
                                    ]
                                }), 1500);
                                if (funcName === 'registerCandidate') return setTimeout(() => {
                                    console.log(`Mock Registered: ${args[0]}, Pattern: ${args[1]}`);
                                    console.log(`Mock Registered: ${args[0]}, Pattern: ${args[1]}`);
                                    resolve('mock-session-id-' + Date.now());
                                }, 800);
                                if (funcName === 'getReferenceDiagrams') return setTimeout(() => resolve([
                                    { id: 'd1', name: '配線図①', url: 'https://via.placeholder.com/600x400?text=Wiring+Diagram+1' },
                                    { id: 'd2', name: '配線図②', url: 'https://via.placeholder.com/600x400?text=Wiring+Diagram+2' },
                                    { id: 'd3', name: 'シーケンス図', url: 'https://via.placeholder.com/600x400?text=Sequence+Diagram' }
                                ]), 500);
                                if (funcName === 'saveReferenceDiagrams') return setTimeout(() => resolve({ success: true, message: 'Mock Diagrams Saved' }), 500);
                                return resolve();
                            }
                            google.script.run
                                .withSuccessHandler(res => {
                                    clearTimeout(timeoutId);
                                    resolve(res);
                                })
                                .withFailureHandler(err => {
                                    clearTimeout(timeoutId);
                                    reject(err);
                                })
                            [funcName](...args);
                        });
                    };

                    // ... (helpers like checkConnection, etc. omitted - no change) ...
                    const checkConnection = async () => { /* ... */ isLoading.value = true; loadingMessage.value = 'Connecting to Gemini...'; try { const res = await runGas('testGeminiConnection'); alert(res.success ? '成功: ' + res.message : '失敗: ' + res.message); } catch (e) { alert('通信エラー: ' + e); } finally { isLoading.value = false; } };
                    const checkGrading = async () => { /* ... */ isLoading.value = true; loadingMessage.value = 'Testing grading logic...'; try { const res = await runGas('testGrading'); if (res.success) { console.log(res.details); alert('成功: ' + res.message + '\n詳細はコンソールを確認してください'); } else { alert('失敗: ' + res.message); } } catch (e) { alert('通信エラー: ' + e); } finally { isLoading.value = false; } };
                    const processImageUrl = (url) => { if (!url) return ''; let match = url.match(/\/d\/([a-zA-Z0-9_-]+)/); if (!match) match = url.match(/id=([a-zA-Z0-9_-]+)/); if (match && match[1]) { return 'https://drive.google.com/uc?export=view&id=' + match[1]; } return url; };
                    const handleImageError = (e) => { console.error('Image load failed'); };
                    const insertChar = (obj, field, char) => { if (!obj[field]) obj[field] = ''; obj[field] += char; };
                    const numberedCircle = (num) => { const chars = ['①', '②', '③', '④', '⑤', '⑥', '⑦', '⑧', '⑨', '⑩']; return chars[num - 1] || `(${num})`; };

                    const getQuestionNumber = (res) => { const idx = questions.value.findIndex(q => q.id === res.questionId); return idx >= 0 ? idx + 1 : '?'; };
                    const getSubQNumber = (res) => { /* ... */ const q = questions.value.find(q => q.id === res.questionId); if (!q || !q.subQuestions) return '?'; const idx = q.subQuestions.findIndex(sq => sq.id === res.subQuestionId); return numberedCircle(idx + 1); };
                    const getAnswerRef = (qId, subId) => { /* ... */ if (!answers.value[qId]) answers.value[qId] = {}; if (typeof answers.value[qId] !== 'object') answers.value[qId] = {}; return { get value() { return answers.value[qId][subId] || ''; }, set value(v) { answers.value[qId][subId] = v; } } };
                    const loadQuestions = async () => { /* ... */ isLoading.value = true; loadingMessage.value = 'Loading questions...'; try { const [qData, pTitle] = await Promise.all([runGas('getQuestions'), runGas('getDeployedPatternTitle')]); questions.value = qData || []; currentDeployedPattern.value = pTitle || ''; if (currentView.value === 'admin' && questions.value.length === 0) { addQuestion(); } } catch (e) { alert('Error: ' + e); } finally { isLoading.value = false; } };

                    const checkPassword = () => { /* ... */ if (inputPassword.value === 'denkitest') { isAuthenticated.value = true; showPasswordModal.value = false; inputPassword.value = ''; authError.value = ''; switchView('admin'); } else { authError.value = 'パスワードが間違っています'; inputPassword.value = ''; } };

                    const switchView = async (view) => {
                        // Admin Auth Check
                        if (view === 'admin' && !isAuthenticated.value) {
                            showPasswordModal.value = true;
                            authError.value = '';
                            return;
                        }

                        if (view === 'examinee') {
                            if (sessionId.value && studentName.value) {
                                currentView.value = 'examinee';
                            } else {
                                showNameModal.value = true;
                                nameError.value = '';
                                loadQuestions();
                                currentView.value = 'examinee';
                            }
                        } else {
                            currentView.value = view;
                            if (view === 'admin') {
                                loadQuestions();
                                loadPatternList();
                            }
                        }

                        if (view !== 'examinee') {
                            // Leave admin mode or landing -> clear test state ONLY if not just switching tabs
                            // But here we reset.
                            testResult.value = null;
                            // answers.value = {}; // Don't clear answers on view switch for safety, mainly explicit reset
                            currentQuestionIndex.value = 0;
                        }
                    };

                    // ... (Question manipulation methods omitted) ...
                    const addQuestion = () => { questions.value.push({ id: Date.now().toString(), text: '', imageUrl: '', points: 10, criteria: '', modelAnswer: '' }); };
                    const removeQuestion = (index) => { questions.value.splice(index, 1); };
                    const addSubQuestion = (q) => { if (!q.subQuestions) q.subQuestions = []; q.subQuestions.push({ id: 'sq-' + Date.now() + Math.random().toString(36).substr(2, 5), text: '', points: 5, criteria: '', modelAnswer: '' }); };
                    const removeSubQuestion = (q, index) => { q.subQuestions.splice(index, 1); };
                    const moveQuestion = (index, direction) => { const newIndex = index + direction; if (newIndex >= 0 && newIndex < questions.value.length) { const item = questions.value.splice(index, 1)[0]; questions.value.splice(newIndex, 0, item); } };
                    const finalizeQuestions = async () => { /* ... */ if (!confirm('Save questions?')) return; isLoading.value = true; loadingMessage.value = 'Saving...'; try { const res = await runGas('saveQuestions', JSON.parse(JSON.stringify(questions.value))); if (res.success) { alert('Saved!'); } else { alert('Save failed: ' + res.message); } } catch (e) { alert('Error: ' + e); } finally { isLoading.value = false; } };
                    const formatDate = (dateStr) => { if (!dateStr) return ''; const d = new Date(dateStr); return d.toLocaleDateString() + ' ' + d.toLocaleTimeString(); };
                    const loadPatternList = async () => { /* ... */ try { const list = await runGas('getPatternList'); savedPatterns.value = list; } catch (e) { console.error('Failed to load patterns', e); } };
                    const savePattern = async () => { /* ... */ if (!patternTitle.value) return; if (!confirm(`パターン「${patternTitle.value}」として保存しますか？`)) return; isLoading.value = true; loadingMessage.value = 'Saving Pattern...'; try { const res = await runGas('savePattern', patternTitle.value, JSON.parse(JSON.stringify(questions.value))); if (res.success) { alert(res.message); await loadPatternList(); selectedPatternTitle.value = patternTitle.value; } else { alert('失敗: ' + res.message); } } catch (e) { alert('Error: ' + e); } finally { isLoading.value = false; } };
                    const loadPattern = async () => { /* ... */ if (!selectedPatternTitle.value) return; if (!confirm(`パターン「${selectedPatternTitle.value}」を読み込みますか？\n編集中の内容は失われます。`)) return; isLoading.value = true; loadingMessage.value = 'Loading Pattern...'; try { const res = await runGas('getPattern', selectedPatternTitle.value); if (res.success) { questions.value = res.questions; patternTitle.value = selectedPatternTitle.value; loadingMessage.value = 'Syncing to Examinee View...'; const saveRes = await runGas('saveQuestions', JSON.parse(JSON.stringify(questions.value)), selectedPatternTitle.value); if (saveRes.success) { alert(`パターン「${selectedPatternTitle.value}」を読み込み、受験者画面に反映しました。`); currentDeployedPattern.value = selectedPatternTitle.value; } else { alert('読み込みは成功しましたが、反映に失敗しました: ' + saveRes.message); } } else { alert('失敗: ' + res.message); } } catch (e) { alert('Error: ' + e); } finally { isLoading.value = false; } };
                    const deletePattern = async () => { /* ... */ if (!selectedPatternTitle.value) return; if (!confirm(`本当に「${selectedPatternTitle.value}」を削除しますか？`)) return; isLoading.value = true; try { const res = await runGas('deletePattern', selectedPatternTitle.value); if (res.success) { alert('削除しました。'); selectedPatternTitle.value = ''; await loadPatternList(); } else { alert('失敗: ' + res.message); } } catch (e) { alert('Error: ' + e); } finally { isLoading.value = false; } };

                    // Diagram Logic
                    const loadReferenceDiagrams = async () => {
                        try {
                            const data = await runGas('getReferenceDiagrams');
                            referenceDiagrams.value = data || [];
                        } catch (e) {
                            console.error("Failed to load diagrams", e);
                        }
                    };

                    const saveDiagramsList = async () => {
                        if (!confirm('図リストを保存しますか？')) return;
                        isLoading.value = true;
                        try {
                            const res = await runGas('saveReferenceDiagrams', JSON.parse(JSON.stringify(referenceDiagrams.value)));
                            if (res.success) {
                                alert(res.message);
                                showDiagramManager.value = false;
                            } else {
                                alert('失敗: ' + res.message);
                            }
                        } catch (e) { alert('Error: ' + e); } finally { isLoading.value = false; }
                    };

                    const addDiagram = () => {
                        referenceDiagrams.value.push({ id: 'diag-' + Date.now(), name: '新規図面', url: '' });
                    };

                    const removeDiagram = (index) => {
                        referenceDiagrams.value.splice(index, 1);
                    };

                    const viewDiagram = (id) => {
                        const d = referenceDiagrams.value.find(d => d.id === id);
                        if (d && d.url) {
                            currentDiagramUrl.value = processImageUrl(d.url);
                            showDiagramViewer.value = true;
                        }
                    };

                    const currentQuestion = computed(() => questions.value[currentQuestionIndex.value]);
                    const isLastQuestion = computed(() => currentQuestionIndex.value === questions.value.length - 1);
                    const nextQuestion = () => { if (!isLastQuestion.value) currentQuestionIndex.value++; };
                    const prevQuestion = () => { if (currentQuestionIndex.value > 0) currentQuestionIndex.value--; };

                    const startExam = async () => {
                        if (!studentName.value.trim()) {
                            nameError.value = "名前を入力してください";
                            return;
                        }
                        isLoading.value = true;
                        loadingMessage.value = '登録中...';
                        try {
                            const sid = await runGas('registerCandidate', studentName.value, currentDeployedPattern.value);
                            sessionId.value = sid;
                            showNameModal.value = false;
                        } catch (e) {
                            alert('登録エラー: ' + e);
                            console.error(e);
                        } finally {
                            isLoading.value = false;
                        }
                    };

                    const cancelExam = () => {
                        showNameModal.value = false;
                        studentName.value = '';
                        sessionId.value = null;
                        switchView('landing');
                    };

                    const submitTest = async () => {
                        if (!confirm('採点を開始して試験を終了しますか？\n（未回答の問題があっても採点されます）')) return;

                        // 1. まず一時保存 (Server Save)
                        isLoading.value = true;
                        isGradingFailed.value = false;
                        loadingMessage.value = 'Saving Answers to Server...';

                        try {
                            const saveRes = await runGas('saveTemporaryAnswers', JSON.parse(JSON.stringify(answers.value)), sessionId.value);

                            if (!saveRes.success) {
                                // 保存失敗時は続行するか確認
                                if (!confirm("回答の一時保存に失敗しました：" + saveRes.message + "\n\nこのまま採点に進みますか？\n(キャンセルすると画面に戻ります)")) {
                                    isLoading.value = false;
                                    return;
                                }
                            }

                            // 2. 採点処理
                            loadingMessage.value = 'AI Grading in progress (this may take 10-20 seconds)...';
                            const res = await runGas('submitAnswers', JSON.parse(JSON.stringify(answers.value)), sessionId.value);

                            if (res.success) {
                                testResult.value = res;
                                isGradingFailed.value = false;
                                // 成功したら一時保存クリア (Local Storage)
                                localStorage.removeItem('elec_test_answers');
                                localStorage.removeItem('elec_test_session_id');
                                localStorage.removeItem('elec_test_student_name');
                            } else {
                                throw new Error(res.message);
                            }
                        } catch (e) {
                            console.error(e);
                            isGradingFailed.value = true;
                            alert('【採点エラー】\n回答はサーバーに保存されていますので、ご安心ください。\n\n詳細: ' + e + '\n\n画面の指示に従って「再試行」するか、管理者に連絡してください。');
                        } finally {
                            isLoading.value = false;
                        }
                    };

                    const resetTest = () => {
                        testResult.value = null;
                        answers.value = {};
                        currentQuestionIndex.value = 0;
                        sessionId.value = null;
                        studentName.value = '';
                        isGradingFailed.value = false;
                        // Clear storage
                        localStorage.removeItem('elec_test_answers');
                        localStorage.removeItem('elec_test_session_id');
                        localStorage.removeItem('elec_test_student_name');
                        switchView('landing');
                    };

                    // --- Auto Save Logic ---
                    watch(answers, (newVal) => {
                        if (currentView.value === 'examinee' && !testResult.value) {
                            localStorage.setItem('elec_test_answers', JSON.stringify(newVal));
                        }
                    }, { deep: true });

                    watch(sessionId, (newVal) => {
                        if (newVal) localStorage.setItem('elec_test_session_id', newVal);
                    });

                    watch(studentName, (newVal) => {
                        if (newVal) localStorage.setItem('elec_test_student_name', newVal);
                    });

                    onMounted(() => {
                        if (questions.value.length === 0) try { addQuestion(); } catch (e) { }
                        if (currentView.value === 'admin') {
                            try { loadPatternList(); } catch (e) { }
                            try { loadReferenceDiagrams(); } catch (e) { }
                        }
                        // Always try to load diagrams as they are needed for examinee too
                        if (currentView.value !== 'admin') {
                            try { loadReferenceDiagrams(); } catch (e) { }
                        }

                        // Restore logic
                        const savedAns = localStorage.getItem('elec_test_answers');
                        const savedSess = localStorage.getItem('elec_test_session_id');
                        const savedName = localStorage.getItem('elec_test_student_name');

                        if (savedAns && savedSess && savedName) {
                            // Restore session if user was in examinee mode
                            // We don't auto-switch view to avoid confusion, but we pre-fill
                            try {
                                answers.value = JSON.parse(savedAns);
                                sessionId.value = savedSess;
                                studentName.value = savedName;
                                console.log('Restored answers from localStorage');
                            } catch (e) {
                                console.error('Restore failed', e);
                            }
                        }
                    });

                    const dragIndex = ref(null);
                    const dragTargetIndex = ref(null);

                    const handleDragStart = (e, index) => {
                        dragIndex.value = index;
                        e.dataTransfer.effectAllowed = 'move';
                        e.dataTransfer.dropEffect = 'move';
                        // ドラッグ中の要素を少し透明にするなどのスタイル適用はCSSクラスで行う
                    };

                    const handleDragEnter = (e, index) => {
                        if (index !== dragIndex.value) {
                            dragTargetIndex.value = index;
                        }
                    };

                    const handleDragOver = (e) => {
                        e.preventDefault(); // ドロップを許可するために必須
                        e.dataTransfer.dropEffect = 'move';
                    };

                    const handleDrop = (index) => {
                        const fromIndex = dragIndex.value;
                        const toIndex = index;

                        if (fromIndex === null || fromIndex === toIndex) {
                            dragIndex.value = null;
                            dragTargetIndex.value = null;
                            return;
                        }

                        // 配列の並び替え
                        const item = questions.value.splice(fromIndex, 1)[0];
                        questions.value.splice(toIndex, 0, item);

                        dragIndex.value = null;
                        dragTargetIndex.value = null;
                    };

                    const createNewPattern = () => {
                        if (questions.value.length > 0) {
                            if (!confirm('現在の編集内容は失われます。新規作成しますか？')) return;
                        }
                        questions.value = [];
                        addQuestion(); // Start with one empty question
                        patternTitle.value = '';
                        selectedPatternTitle.value = '';
                        // Do not clear currentDeployedPattern as we usually want to know what is live
                    };

                    const totalMaxScore = computed(() => {
                        return questions.value.reduce((sum, q) => {
                            if (q.subQuestions && q.subQuestions.length > 0) {
                                return sum + q.subQuestions.reduce((s, sq) => s + (Number(sq.points) || 0), 0);
                            }
                            return sum + (Number(q.points) || 0);
                        }, 0);
                    });

                    const getQuestionText = (res) => {
                        if (res.questionText) return res.questionText;
                        const q = questions.value.find(q => q.id === res.questionId);
                        if (!q) return '(不明な問題)';
                        if (res.subQuestionId && q.subQuestions) {
                            const sq = q.subQuestions.find(sq => sq.id === res.subQuestionId);
                            return sq ? sq.text : '(不明な小問)';
                        }
                        return q.text;
                    };

                    const getUserAnswer = (res) => {
                        const ans = answers.value[res.questionId];
                        if (!ans) return '(無回答)';
                        if (res.subQuestionId) {
                            return (typeof ans === 'object' && ans[res.subQuestionId]) ? ans[res.subQuestionId] : '(無回答)';
                        }
                        return (typeof ans === 'string') ? ans : '(形式エラー)';
                    };

                    const getResultStatus = (res) => {
                        const q = questions.value.find(q => q.id === res.questionId);
                        if (!q) return { label: '-', class: 'text-gray-400', icon: 'fa-minus' };

                        let maxPoints = q.points;
                        if (res.subQuestionId && q.subQuestions) {
                            const sq = q.subQuestions.find(sq => sq.id === res.subQuestionId);
                            if (sq) maxPoints = sq.points;
                        }

                        if (res.score >= maxPoints) return { label: '正解', class: 'text-green-600 bg-green-50 border-green-200', icon: 'fa-circle-check' };
                        if (res.score <= 0) return { label: '不正解', class: 'text-red-600 bg-red-50 border-red-200', icon: 'fa-circle-xmark' };
                        return { label: '部分点', class: 'text-yellow-600 bg-yellow-50 border-yellow-200', icon: 'fa-circle-exclamation' };
                    };

                    const getCriteria = (res) => { // これはAIプロンプト（デバッグ用か、非表示にする）
                        const q = questions.value.find(q => q.id === res.questionId);
                        if (!q) return '';
                        if (res.subQuestionId && q.subQuestions) {
                            const sq = q.subQuestions.find(sq => sq.id === res.subQuestionId);
                            return sq ? sq.criteria : '';
                        }
                        return q.criteria;
                    };

                    const getModelAnswer = (res) => {
                        if (res.modelAnswer) return res.modelAnswer;
                        const q = questions.value.find(q => q.id === res.questionId);
                        if (!q) return '';
                        let target = q;
                        if (res.subQuestionId && q.subQuestions) {
                            const sq = q.subQuestions.find(sq => sq.id === res.subQuestionId);
                            if (sq) target = sq;
                        }
                        // criteriaへのフォールバックを削除し、安全なデフォルトメッセージを表示
                        return target.modelAnswer || '（模範解答設定なし）';
                    };

                    const getQuestionImage = (res) => {
                        // 型不一致(String/Number)を考慮して == で比較
                        const q = questions.value.find(q => q.id == res.questionId);
                        if (!q) return '';

                        // 親問題の画像を表示
                        return q.imageUrl || '';
                    };

                    const escapeHtml = (unsafe) => {
                        if (!unsafe) return '';
                        return unsafe
                            .replace(/&/g, "&amp;")
                            .replace(/</g, "&lt;")
                            .replace(/>/g, "&gt;")
                            .replace(/"/g, "&quot;")
                            .replace(/'/g, "&#039;");
                    };

                    // --- CSV Export Logic ---
                    const downloadCSV = (filename, headers, rows) => {
                        // BOM for Excel
                        const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
                        let csvContent = headers.join(',') + '\n';

                        rows.forEach(row => {
                            const processedRow = row.map(cell => {
                                let val = String(cell || '');
                                // Escape double quotes and wrap in quotes if necessary
                                if (val.search(/("|,|\n)/g) >= 0) {
                                    val = `"${val.replace(/"/g, '""')}"`;
                                }
                                return val;
                            });
                            csvContent += processedRow.join(',') + '\n';
                        });

                        const blob = new Blob([bom, csvContent], { type: 'text/csv;charset=utf-8;' });
                        const link = document.createElement('a');
                        if (link.download !== undefined) {
                            const url = URL.createObjectURL(blob);
                            link.setAttribute('href', url);
                            link.setAttribute('download', filename);
                            link.style.visibility = 'hidden';
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                        }
                    };

                    const getFormattedTimestamp = () => {
                        const now = new Date();
                        return `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}`;
                    };

                    const cleanText = (text) => {
                        if (!text) return '';
                        // Remove HTML tags or Markdown-like syntax if needed, but keeping it simple for now
                        // Just strip newlines for CSV cell safety (though the CSV generator handles them, it might be cleaner)
                        // Actually, let's keep newlines but ensure they are quoted (handled by downloadCSV)
                        return text;
                    };

                    const downloadAnswersCSV = () => {
                        if (questions.value.length === 0) return;
                        const filename = `ElecTest_Answers_${studentName.value || 'Candidate'}_${getFormattedTimestamp()}.csv`;
                        const headers = ['問題番号', '問題文', 'あなたの回答'];
                        const rows = [];

                        questions.value.forEach((q, idx) => {
                            // Main question
                            if (!q.subQuestions || q.subQuestions.length === 0) {
                                const ans = answers.value[q.id] || '';
                                rows.push([
                                    `Q${idx + 1}`,
                                    cleanText(q.text),
                                    cleanText(ans)
                                ]);
                            } else {
                                // Has subquestions
                                rows.push([`Q${idx + 1}`, cleanText(q.text), '(以下小問)']);
                                q.subQuestions.forEach((sq, sIdx) => {
                                    const ans = (answers.value[q.id] && answers.value[q.id][sq.id]) || '';
                                    rows.push([
                                        `Q${idx + 1}-${sIdx + 1}`,
                                        cleanText(sq.text),
                                        cleanText(ans)
                                    ]);
                                });
                            }
                        });

                        downloadCSV(filename, headers, rows);
                    };

                    const downloadResultsCSV = () => {
                        if (!testResult.value) return;
                        const filename = `ElecTest_Result_${studentName.value || 'Candidate'}_${getFormattedTimestamp()}.csv`;
                        // Header: 問題番号, 結果, 得点, 配点, 問題文, あなたの回答, 模範解答, AI講評
                        const headers = ['問題番号', '結果', '得点', '配点', '問題文', 'あなたの回答', '模範解答', 'AI講評'];
                        const rows = [];

                        testResult.value.results.forEach(res => {
                            const q = questions.value.find(q => q.id === res.questionId);
                            if (!q) return;

                            let qNumStr = `Q${getQuestionNumber(res)}`;
                            let problemText = q.text;
                            let maxPoints = q.points;
                            let modelAns = q.modelAnswer || '';

                            if (res.subQuestionId && q.subQuestions) {
                                const sq = q.subQuestions.find(sq => sq.id === res.subQuestionId);
                                if (sq) {
                                    qNumStr += `-${getSubQNumber(res).replace(/[()]/g, '')}`; // Remove parens for cleaner CSV
                                    problemText = sq.text;
                                    maxPoints = sq.points;
                                    modelAns = sq.modelAnswer || '';
                                }
                            }

                            const status = getResultStatus(res).label;
                            const userAns = getUserAnswer(res);

                            rows.push([
                                qNumStr,
                                status,
                                res.score,
                                maxPoints,
                                cleanText(problemText),
                                cleanText(userAns),
                                cleanText(modelAns),
                                cleanText(res.reason)
                            ]);
                        });

                        // Add Total Score Row
                        rows.unshift(['合計', '', testResult.value.totalScore, totalMaxScore.value, '', '', '', '']);

                        downloadCSV(filename, headers, rows);
                    };

                    const renderMath = (text) => {
                        if (!text) return '';
                        let temp = text;
                        const placeholders = [];
                        const push = (html) => {
                            placeholders.push(html);
                            return `__KATEX_${placeholders.length - 1}__`;
                        };

                        // Render Display Math $$...$$
                        temp = temp.replace(/\$\$([\s\S]*?)\$\$/g, (match, tex) => {
                            try {
                                return push(katex.renderToString(tex, { displayMode: true, throwOnError: false, output: 'html' }));
                            } catch (e) { return match; }
                        });

                        // Render Inline Math $...$
                        // Note: Be careful with text that contains $ but isn't math. 
                        // But standard convention in this app will be $ as delimiter.
                        temp = temp.replace(/\$([^$\n]+?)\$/g, (match, tex) => {
                            try {
                                return push(katex.renderToString(tex, { displayMode: false, throwOnError: false, output: 'html' }));
                            } catch (e) { return match; }
                        });

                        let escaped = escapeHtml(temp);

                        // Restore placeholders
                        placeholders.forEach((html, i) => {
                            escaped = escaped.replace(`__KATEX_${i}__`, html);
                        });

                        return escaped;
                    };

                    return {
                        currentView, isLoading, loadingMessage, questions, currentQuestionIndex,
                        isAuthenticated, showPasswordModal, inputPassword, authError, checkPassword, // Export auth vars/funcs
                        answers, testResult, currentQuestion, isLastQuestion, totalMaxScore,
                        switchView, addQuestion, removeQuestion, moveQuestion, finalizeQuestions,
                        nextQuestion, prevQuestion, submitTest, resetTest, checkConnection, checkGrading,
                        processImageUrl, handleImageError, insertChar,
                        handleDragStart, handleDragEnter, handleDragOver, handleDrop, dragIndex, dragTargetIndex,
                        addSubQuestion, removeSubQuestion, numberedCircle, getSubQNumber, getQuestionNumber, getAnswerRef,
                        getQuestionText, getUserAnswer, getResultStatus, getCriteria, getModelAnswer, getQuestionImage,
                        renderMath, downloadAnswersCSV, downloadResultsCSV,
                        // Pattern Management
                        patternTitle, selectedPatternTitle, savedPatterns, formatDate,
                        savePattern, loadPattern, deletePattern, currentDeployedPattern, createNewPattern,
                        // Diagram Management
                        referenceDiagrams, showDiagramManager, showDiagramViewer, showDiagramList, currentDiagramUrl,
                        loadReferenceDiagrams, saveDiagramsList, addDiagram, removeDiagram, viewDiagram,
                        // Candidate Management
                        showNameModal, studentName, nameError, startExam, cancelExam
                    }
                }
            }).mount('#app');
        } catch (e) {
            console.error('App Init Error:', e);
            document.getElementById('error-display').style.display = 'block';
            document.getElementById('error-display').innerHTML = '<strong>App Init Error:</strong> ' + e.toString();
        }
    </script>
</body>

</html>