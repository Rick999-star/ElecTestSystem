<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ElecTest System</title>
    <!-- Tailwind CSS (Play CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb', // blue-600
                        secondary: '#475569', // slate-600
                        accent: '#0d9488', // teal-600
                    }
                }
            }
        }
    </script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50 text-gray-800 font-sans antialiased">
    <div id="app" class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-white shadow-sm z-10 sticky top-0">
            <div class="max-w-5xl mx-auto px-4 py-4 flex justify-between items-center">
                <h1 class="text-xl font-bold text-gray-800 tracking-tight">
                    <i class="fa-solid fa-bolt text-yellow-500 mr-2"></i>ElecTest System
                </h1>
                <div class="space-x-2">
                    <button @click="currentView = 'admin'" 
                        :class="['px-3 py-1 rounded-full text-sm font-medium transition', currentView === 'admin' ? 'bg-primary text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200']">
                        管理者
                    </button>
                    <button @click="currentView = 'examinee'" 
                        :class="['px-3 py-1 rounded-full text-sm font-medium transition', currentView === 'examinee' ? 'bg-accent text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200']">
                        受験者
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow p-4 md:p-6">
            <div class="max-w-3xl mx-auto w-full">
                
                <!-- Admin View -->
                <div v-if="currentView === 'admin'" class="space-y-6">
                    <div class="flex justify-between items-center bg-white p-4 rounded-lg shadow-sm border border-gray-100">
                        <div>
                            <h2 class="text-lg font-semibold text-gray-800">問題作成</h2>
                            <p class="text-sm text-gray-500">新しいテストの問題を追加・編集します</p>
                        </div>
                        <button @click="finalizeTest" class="bg-primary hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg shadow-md transition flex items-center gap-2">
                            <i class="fa-solid fa-check"></i> テストを確定
                        </button>
                    </div>

                    <!-- Question List -->
                    <div class="space-y-4">
                        <div v-for="(q, index) in questions" :key="q.id" class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden hover:shadow-md transition">
                            <div class="bg-gray-50 px-4 py-2 border-b border-gray-100 flex justify-between items-center">
                                <span class="font-bold text-gray-600">Q{{ index + 1 }}</span>
                                <button @click="removeQuestion(index)" class="text-red-400 hover:text-red-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-50 transition">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                            <div class="p-5 space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">問題文</label>
                                    <textarea v-model="q.text" placeholder="ここに問題文を入力してください..." rows="3" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition"></textarea>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">参考画像URL (任意)</label>
                                        <div class="flex">
                                            <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 bg-gray-50 text-gray-500 text-sm">
                                                <i class="fa-regular fa-image"></i>
                                            </span>
                                            <input type="text" v-model="q.imageUrl" placeholder="https://example.com/fig1.png" class="flex-1 min-w-0 block w-full px-3 py-2 rounded-r-md border border-gray-300 focus:ring-primary focus:border-primary sm:text-sm">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">配点</label>
                                        <input type="number" v-model.number="q.points" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-primary focus:border-transparent outline-none transition" min="0" max="100">
                                    </div>
                                </div>
                                <div v-if="q.imageUrl" class="mt-2 p-2 bg-gray-50 rounded border border-gray-200 inline-block">
                                    <p class="text-xs text-gray-500 mb-1">プレビュー:</p>
                                    <img :src="q.imageUrl" alt="Preview" class="h-32 object-contain rounded">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Add Button -->
                    <button @click="addQuestion" class="w-full py-4 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 hover:border-primary hover:text-primary hover:bg-blue-50 transition flex flex-col items-center justify-center gap-2">
                        <i class="fa-solid fa-circle-plus text-2xl"></i>
                        <span class="font-medium">問題を追加</span>
                    </button>
                    
                    <div class="h-10"></div> <!-- Spacer -->
                </div>

                <!-- Examinee View -->
                <div v-else class="space-y-6">
                    <!-- Progress -->
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-gray-500">Question {{ currentQuestionIndex + 1 }} of {{ questions.length }}</span>
                        <span class="text-sm font-medium text-accent">{{ Math.round(((currentQuestionIndex + 1) / questions.length) * 100) }}% complete</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mb-6">
                        <div class="bg-accent h-2.5 rounded-full transition-all duration-300" :style="{ width: ((currentQuestionIndex + 1) / questions.length) * 100 + '%' }"></div>
                    </div>

                    <!-- Question Card -->
                    <div v-if="currentQuestion" class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
                        <div class="p-6 md:p-8 space-y-6">
                            <!-- Question Text -->
                            <div>
                                <h3 class="text-xl md:text-2xl font-bold text-gray-800 leading-relaxed">
                                    {{ currentQuestion.text }}
                                </h3>
                            </div>

                            <!-- Image -->
                            <div v-if="currentQuestion.imageUrl" class="flex justify-center bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <img :src="currentQuestion.imageUrl" class="max-h-64 object-contain rounded shadow-sm">
                            </div>

                            <!-- Answer Area -->
                            <div class="mt-6">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    回答欄 <span class="bg-red-100 text-red-600 text-xs px-2 py-0.5 rounded ml-2">記述式</span>
                                </label>
                                <textarea v-model="answers[currentQuestion.id]" 
                                    class="w-full h-48 px-4 py-3 text-lg text-gray-800 bg-gray-50 rounded-lg border border-gray-300 focus:bg-white focus:ring-2 focus:ring-accent focus:border-transparent outline-none transition resize-none"
                                    placeholder="ここに回答を記述してください..."></textarea>
                                <div class="text-right mt-2 text-xs text-gray-400">
                                    {{ (answers[currentQuestion.id] || '').length }} 文字
                                </div>
                            </div>
                        </div>
                        
                        <!-- Actions -->
                        <div class="bg-gray-50 px-6 py-4 border-t border-gray-100 flex justify-between items-center">
                            <button @click="prevQuestion" 
                                :disabled="currentQuestionIndex === 0"
                                :class="['px-5 py-2 rounded-lg font-medium transition flex items-center gap-2', currentQuestionIndex === 0 ? 'text-gray-300 cursor-not-allowed' : 'text-gray-600 hover:bg-gray-200']">
                                <i class="fa-solid fa-arrow-left"></i> 前へ
                            </button>
                            
                            <button v-if="!isLastQuestion" @click="nextQuestion" 
                                class="bg-white border border-gray-300 hover:bg-gray-50 text-gray-800 px-6 py-2.5 rounded-lg shadow-sm font-medium transition flex items-center gap-2">
                                次へ <i class="fa-solid fa-arrow-right text-gray-400"></i>
                            </button>
                            
                            <button v-else @click="submitTest" 
                                class="bg-accent hover:bg-teal-700 text-white px-8 py-2.5 rounded-lg shadow-lg shadow-teal-500/30 font-bold transition flex items-center gap-2">
                                回答を送信 <i class="fa-solid fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Vue Application Script -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
        const { createApp, ref, computed } = Vue

        createApp({
            setup() {
                // State
                const currentView = ref('admin') // 'admin' or 'examinee'
                const questions = ref([
                    { id: '1', text: 'オームの法則について説明してください。', imageUrl: '', points: 10 }
                ])
                const currentQuestionIndex = ref(0)
                const answers = ref({}) // Key: questionId, Value: text

                // Admin Actions
                const addQuestion = () => {
                    questions.value.push({
                        id: Date.now().toString(),
                        text: '',
                        imageUrl: '',
                        points: 10
                    })
                }

                const removeQuestion = (index) => {
                    questions.value.splice(index, 1)
                }

                const finalizeTest = () => {
                    if (confirm('テストを確定して、スプレッドシートに保存しますか？（モック動作）')) {
                        console.log('Sending data to GAS:', questions.value)
                        alert('保存しました！受験者ビューに切り替えます。')
                        currentView.value = 'examinee'
                        currentQuestionIndex.value = 0
                        answers.value = {}
                    }
                }

                // Examinee Actions
                const currentQuestion = computed(() => questions.value[currentQuestionIndex.value])
                const isLastQuestion = computed(() => currentQuestionIndex.value === questions.value.length - 1)

                const nextQuestion = () => {
                    if (currentQuestionIndex.value < questions.value.length - 1) {
                        currentQuestionIndex.value++
                    }
                }

                const prevQuestion = () => {
                    if (currentQuestionIndex.value > 0) {
                        currentQuestionIndex.value--
                    }
                }

                const submitTest = () => {
                    // Validation
                    const unanswered = questions.value.filter(q => !answers.value[q.id] || !answers.value[q.id].trim())
                    
                    let msg = '回答を送信して採点を開始しますか？'
                    if (unanswered.length > 0) {
                        msg = `まだ回答していない問題が ${unanswered.length} 問あります。\n` + msg
                    }

                    if (confirm(msg)) {
                        console.log('Submitting answers:', answers.value)
                        alert('送信完了！採点結果をお待ちください。（モック動作）')
                    }
                }

                return {
                    currentView,
                    questions,
                    currentQuestionIndex,
                    currentQuestion,
                    isLastQuestion,
                    answers,
                    addQuestion,
                    removeQuestion,
                    finalizeTest,
                    nextQuestion,
                    prevQuestion,
                    submitTest
                }
            }
        }).mount('#app')
    </script>
</body>
</html>
